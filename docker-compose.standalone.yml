version: "3.8"

# Top-level extension for shared build arguments
x-build-args: &common-build-args
  IMAGE_NAME: "${REGISTRY_IMAGE:-makerkit}:${IMAGE_TAG:-latest}"
  AUTORUN_ENABLED: false
  AUTORUN_LARAVEL_CONFIG_CACHE: false
  AUTORUN_LARAVEL_EVENT_CACHE: false
  AUTORUN_LARAVEL_ROUTE_CACHE: false
  AUTORUN_LARAVEL_VIEW_CACHE: false
  AUTORUN_LARAVEL_STORAGE_LINK: false

# Top-level extension for shared environment variables
x-env-variables: &common-env
  APP_NAME: "${APP_NAME}"
  APP_ENV: "${APP_ENV:-development}"
  APP_KEY: "${APP_KEY}"
  APP_DEBUG: "${APP_DEBUG:-false}"
  APP_URL: "${APP_URL}"
  APP_LOCALE: "${APP_LOCALE}"
  APP_FALLBACK_LOCALE: "${APP_FALLBACK_LOCALE}"
  APP_FAKER_LOCALE: "${APP_FAKER_LOCALE}"
  APP_MAINTENANCE_DRIVER: "${APP_MAINTENANCE_DRIVER}"
  PHP_CLI_SERVER_WORKERS: "${PHP_CLI_SERVER_WORKERS}"
  BCRYPT_ROUNDS: "${BCRYPT_ROUNDS}"
  LOG_CHANNEL: "${LOG_CHANNEL}"
  LOG_STACK: "${LOG_STACK}"
  LOG_DEPRECATIONS_CHANNEL: "${LOG_DEPRECATIONS_CHANNEL}"
  LOG_LEVEL: "${LOG_LEVEL}"
  DB_CONNECTION: "pgsql"
  DB_HOST: "${DB_HOST}"
  DB_PORT: "${DB_PORT:-5432}"
  DB_DATABASE: "${DB_DATABASE:-postgres}"
  DB_USERNAME: "${DB_USERNAME:-postgres}"
  DB_PASSWORD: "${DB_PASSWORD}"
  SESSION_DRIVER: "${SESSION_DRIVER}"
  SESSION_LIFETIME: "${SESSION_LIFETIME}"
  SESSION_ENCRYPT: "${SESSION_ENCRYPT}"
  SESSION_PATH: "${SESSION_PATH}"
  SESSION_DOMAIN: "${SESSION_DOMAIN}"
  BROADCAST_CONNECTION: "${BROADCAST_CONNECTION}"
  FILESYSTEM_DISK: "${FILESYSTEM_DISK}"
  QUEUE_CONNECTION: "${QUEUE_CONNECTION}"
  CACHE_STORE: "${CACHE_STORE}"
  MEMCACHED_HOST: "${MEMCACHED_HOST}"
  REDIS_CLIENT: "${REDIS_CLIENT}"
  REDIS_HOST: "${REDIS_HOST}"
  REDIS_PASSWORD: "${REDIS_PASSWORD}"
  REDIS_PORT: "${REDIS_PORT}"
  MAIL_MAILER: "${MAIL_MAILER}"
  MAIL_SCHEME: "${MAIL_SCHEME}"
  MAIL_HOST: "${MAIL_HOST}"
  MAIL_PORT: "${MAIL_PORT}"
  MAIL_USERNAME: "${MAIL_USERNAME}"
  MAIL_PASSWORD: "${MAIL_PASSWORD}"
  MAIL_FROM_ADDRESS: "${MAIL_FROM_ADDRESS}"
  MAIL_FROM_NAME: "${MAIL_FROM_NAME}"
  VITE_APP_NAME: "${VITE_APP_NAME}"
  R2_ACCESS_KEY_ID: "${R2_ACCESS_KEY_ID}"
  R2_URL: "${R2_URL}"
  R2_SECRET_ACCESS_KEY: "${R2_SECRET_ACCESS_KEY}"
  R2_BUCKET: "${R2_BUCKET}"
  R2_ENDPOINT: "${R2_ENDPOINT}"
  R2_TOKEN: "${R2_TOKEN}"
  INERTIA_SSR_URL: "${INERTIA_SSR_URL:-http://inertia:13714}"
  WORKSPACES_ENABLED: "${WORKSPACES_ENABLED:-true}"
  WORKSPACES_CAN_CREATE_WORKSPACES: "${WORKSPACES_CAN_CREATE_WORKSPACES:-true}"
  MAGICLINK_ENABLED: "${MAGICLINK_ENABLED:-true}"
  PASSWORD_ENABLED: "${PASSWORD_ENABLED:-true}"
  SOCIALITE_ENABLED: "${SOCIALITE_ENABLED:-true}"
  SOCIALITE_PROVIDERS: "${SOCIALITE_PROVIDERS:-google}" # add more providers as needed, seperated by comma

services:
  laravel:
    build:
      context: .
      dockerfile: docker/standalone/Dockerfile
      args:
        <<: *common-build-args
        AUTORUN_ENABLED: true
        AUTORUN_LARAVEL_CONFIG_CACHE: true
        AUTORUN_LARAVEL_EVENT_CACHE: true
        AUTORUN_LARAVEL_ROUTE_CACHE: true
        AUTORUN_LARAVEL_VIEW_CACHE: true
        AUTORUN_LARAVEL_STORAGE_LINK: true
    image: "${REGISTRY_IMAGE:-makerkit}:${IMAGE_TAG:-latest}"
    restart: unless-stopped
    environment:
      <<: *common-env
      # any service-specific overrides go here
    ports:
      - "50901:8080"
    volumes:
      - storage:/var/www/html/storage
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:8080/healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  inertia:
    build:
      context: .
      dockerfile: docker/standalone/Dockerfile
      args:
        <<: *common-build-args
    image: "${REGISTRY_IMAGE:-makerkit}:${IMAGE_TAG:-latest}"
    restart: unless-stopped
    command: ["php", "/var/www/html/artisan", "inertia:start-ssr"]
    environment:
      <<: *common-env
      # any service-specific overrides go here
    volumes:
      - storage:/var/www/html/storage
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:8080/healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  worker:
    build:
      context: .
      dockerfile: docker/standalone/Dockerfile
      args:
        <<: *common-build-args
    image: "${REGISTRY_IMAGE:-makerkit}:${IMAGE_TAG:-latest}"
    restart: unless-stopped
    depends_on:
      - laravel
      - inertia
    environment:
      <<: *common-env
    volumes:
      - storage:/var/www/html/storage
    command: ["php", "/var/www/html/artisan", "queue:work", "--tries=2"]
    healthcheck:
      test: ["CMD", "healthcheck-queue"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  scheduler:
    build:
      context: .
      dockerfile: docker/standalone/Dockerfile
      args:
        <<: *common-build-args
    image: "${REGISTRY_IMAGE:-makerkit}:${IMAGE_TAG:-latest}"
    restart: unless-stopped
    depends_on:
      - laravel
      - inertia
    environment:
      <<: *common-env
    volumes:
      - storage:/var/www/html/storage
    command: ["php", "/var/www/html/artisan", "schedule:work"]
    healthcheck:
      test: ["CMD", "healthcheck-schedule"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  storage:
