name: Deploy Infrastructure

on:
  push:
    paths:
      - 'INFRASTRUCTURE/**'
    branches: [main]
  workflow_dispatch:
    inputs:
      action:
        description: 'Pulumi action'
        required: true
        type: choice
        options:
          - preview
          - up
          - destroy

env:
  PULUMI_CONFIG_PASSPHRASE: ${{ secrets.PULUMI_CONFIG_PASSPHRASE }}
  AWS_REGION: us-east-1

jobs:
  deploy:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        working-directory: INFRASTRUCTURE
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Verify AWS connectivity
        run: |
          echo "Testing AWS connectivity..."
          aws sts get-caller-identity || {
            echo "❌ ERROR: Failed to authenticate with AWS"
            echo "Please verify your AWS credentials are correct"
            exit 1
          }
          echo "✅ AWS authentication successful"

      - name: Install Pulumi CLI
        uses: pulumi/actions@v5

      - name: Login to Pulumi Cloud
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
        run: |
          if [ -z "$PULUMI_ACCESS_TOKEN" ]; then
            echo "❌ ERROR: PULUMI_ACCESS_TOKEN secret is not set"
            echo "Please create a Pulumi access token at: https://app.pulumi.com/account/tokens"
            echo "Then add it to GitHub Secrets as PULUMI_ACCESS_TOKEN"
            exit 1
          fi
          pulumi login

      - name: Set up Pulumi stack
        working-directory: INFRASTRUCTURE
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
          PULUMI_ORG: shinejohn
        run: |
          # Organization and stack from PULUMI_SETUP.md
          ORG_NAME="shinejohn"
          PROJECT_NAME="fibonacco-infrastructure"
          STACK_NAME="dev"
          
          echo "Checking for stack: $ORG_NAME/$PROJECT_NAME/$STACK_NAME"
          
          # Try to select the stack
          if pulumi stack select "$ORG_NAME/$PROJECT_NAME/$STACK_NAME" 2>/dev/null; then
            echo "✅ Stack exists: $ORG_NAME/$PROJECT_NAME/$STACK_NAME"
          else
            echo "⚠️  Stack not found, creating: $STACK_NAME"
            pulumi stack init "$STACK_NAME" --secrets-provider passphrase || {
              echo "❌ Failed to create stack"
              echo "Make sure the project is initialized in Pulumi Cloud"
              exit 1
            }
          fi
          
          # Verify stack selection
          pulumi stack select "$ORG_NAME/$PROJECT_NAME/$STACK_NAME" || pulumi stack select "$STACK_NAME"

      - name: Preview changes
        if: github.event.inputs.action == 'preview' || github.event_name == 'push'
        working-directory: INFRASTRUCTURE
        run: |
          pulumi preview --stack dev

      - name: Deploy infrastructure
        if: github.event.inputs.action == 'up'
        working-directory: INFRASTRUCTURE
        run: |
          pulumi up --stack dev --yes

      - name: Destroy infrastructure
        if: github.event.inputs.action == 'destroy'
        working-directory: INFRASTRUCTURE
        run: |
          pulumi destroy --stack dev --yes

