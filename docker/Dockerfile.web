# Web Application Dockerfile
# Used for GoEventCity, Day.News, Downtown Guide, AlphaSite

# Stage 1: Build frontend assets
# Using public.ecr.aws to avoid Docker Hub rate limits
FROM public.ecr.aws/docker/library/node:20-alpine AS frontend-builder

WORKDIR /app

# Install PHP and Composer for Ziggy route generation
# Install composer via Alpine package manager (more reliable than installer script)
# Only install essential PHP extensions - we use --ignore-platform-reqs for composer install
RUN apk add --no-cache \
    php \
    php-json \
    php-mbstring \
    php-xml \
    php-tokenizer \
    php-phar \
    php-openssl \
    php-zlib \
    curl \
    composer

# Copy Composer files first to install Ziggy
COPY composer.json composer.lock ./

# Verify composer is installed
RUN composer --version || { \
        echo "❌ Composer not found!"; \
        echo "PHP version:"; \
        php -v; \
        echo "PHP extensions:"; \
        php -m; \
        which composer || echo "composer not in PATH"; \
        exit 1; \
    }

# Install only Ziggy (needed for frontend build)
# Use --ignore-platform-reqs since we only need Ziggy files, not to run PHP code
RUN composer install --no-dev --no-scripts --no-autoloader --ignore-platform-reqs --quiet && \
    echo "✅ Composer install succeeded" && \
    ls -la vendor/tightenco/ziggy || { \
    echo "❌ Composer install failed!"; \
    composer install --no-dev --no-scripts --no-autoloader --ignore-platform-reqs --verbose; \
    exit 1; \
    }

# Copy package files
COPY package*.json ./

# Install Node dependencies
RUN npm ci

# Copy application source
COPY . .

# Build frontend assets (show errors if build fails)
RUN npm run build || { \
    echo "❌ npm build failed! Showing error:"; \
    npm run build 2>&1; \
    exit 1; \
    }

# Stage 2: PHP application
# Using public.ecr.aws to avoid Docker Hub rate limits
FROM public.ecr.aws/docker/library/php:8.4-fpm-alpine

# Install system dependencies
RUN apk add --no-cache \
    git \
    curl \
    libpng-dev \
    libzip-dev \
    zip \
    unzip \
    postgresql-dev \
    oniguruma-dev \
    icu-dev \
    libxml2-dev \
    nginx \
    supervisor \
    autoconf \
    g++ \
    make \
    && docker-php-ext-install \
    pdo \
    pdo_pgsql \
    mbstring \
    exif \
    pcntl \
    bcmath \
    gd \
    zip \
    opcache \
    intl \
    xml \
    dom \
    simplexml \
    && pecl install redis \
    && docker-php-ext-enable redis \
    && docker-php-ext-enable pcntl simplexml dom xml intl
    # Redis extension installed for Laravel cache/session/queue
    # Note: session and fileinfo are built-in extensions and don't need explicit enabling

# Configure PHP phar extension
# Note: phar.require_hash doesn't disable signature verification in PHP 8.4
# We'll handle signature verification during Composer installation
RUN echo "phar.readonly = Off" > /usr/local/etc/php/conf.d/phar.ini

# Verify PHP extensions are installed and enabled BEFORE composer
# session and fileinfo are built-in PHP extensions that should be available by default
RUN echo "=== Checking PHP extensions ===" && \
    php -m && \
    echo "" && \
    echo "=== Required extensions check ===" && \
    php -r "if (!extension_loaded('session')) { echo 'ERROR: session extension not loaded\n'; exit(1); }" && \
    php -r "if (!extension_loaded('fileinfo')) { echo 'ERROR: fileinfo extension not loaded\n'; exit(1); }" && \
    php -r "if (!extension_loaded('simplexml')) { echo 'ERROR: simplexml extension not loaded\n'; exit(1); }" && \
    php -r "if (!extension_loaded('intl')) { echo 'ERROR: intl extension not loaded\n'; exit(1); }" && \
    php -r "if (!extension_loaded('pcntl')) { echo 'ERROR: pcntl extension not loaded\n'; exit(1); }" && \
    php -r "if (!extension_loaded('dom')) { echo 'ERROR: dom extension not loaded\n'; exit(1); }" && \
    php -r "if (!extension_loaded('xml')) { echo 'ERROR: xml extension not loaded\n'; exit(1); }" && \
    php -r "if (!extension_loaded('redis')) { echo 'ERROR: redis extension not loaded\n'; exit(1); }" && \
    php -m | grep -E "(simplexml|intl|session|pcntl|fileinfo|dom|xml|redis)" && \
    echo "✅ All required extensions are loaded"

# Install Composer - download PHAR directly (more reliable for PHP 8.4 signature verification)
# PHP 8.4 has stricter PHAR signature verification, so we use the official pre-built PHAR
RUN set -eux; \
    echo "=== Installing Composer ==="; \
    MAX_RETRIES=3; \
    RETRY=0; \
    INSTALL_SUCCESS=0; \
    while [ $RETRY -lt $MAX_RETRIES ] && [ $INSTALL_SUCCESS -eq 0 ]; do \
        echo "=== Composer installation attempt $((RETRY+1))/$MAX_RETRIES ==="; \
        rm -f /usr/local/bin/composer /tmp/composer.phar; \
        curl -sS https://getcomposer.org/download/latest-stable/composer.phar -o /tmp/composer.phar || { \
            echo "⚠️ Failed to download Composer PHAR, retrying..."; \
            RETRY=$((RETRY+1)); \
            sleep 2; \
            continue; \
        }; \
        mv /tmp/composer.phar /usr/local/bin/composer && \
        chmod +x /usr/local/bin/composer && \
        if /usr/local/bin/php /usr/local/bin/composer --version > /dev/null 2>&1; then \
            echo "✅ Composer installed and verified successfully"; \
            INSTALL_SUCCESS=1; \
        else \
            echo "⚠️ Composer PHAR signature verification failed (attempt $((RETRY+1))/$MAX_RETRIES)"; \
            echo "Error details:"; \
            /usr/local/bin/php /usr/local/bin/composer --version 2>&1 || true; \
            RETRY=$((RETRY+1)); \
            sleep 2; \
        fi; \
    done; \
    if [ $INSTALL_SUCCESS -eq 0 ]; then \
        echo "⚠️ Direct PHAR download failed, trying installer script..."; \
        rm -f /usr/local/bin/composer /tmp/composer-setup.php; \
        EXPECTED_SIGNATURE=$(curl -sS https://composer.github.io/installer.sig) && \
        curl -sS https://getcomposer.org/installer -o /tmp/composer-setup.php && \
        ACTUAL_SIGNATURE=$(/usr/local/bin/php -r "echo hash_file('sha384', '/tmp/composer-setup.php');") && \
        if [ "$EXPECTED_SIGNATURE" = "$ACTUAL_SIGNATURE" ]; then \
            echo "✅ Installer signature verified, running installer..."; \
            /usr/local/bin/php /tmp/composer-setup.php --install-dir=/usr/local/bin --filename=composer --quiet && \
            rm -f /tmp/composer-setup.php && \
            chmod +x /usr/local/bin/composer; \
        fi; \
        if ! /usr/local/bin/php /usr/local/bin/composer --version > /dev/null 2>&1; then \
            echo "❌ All Composer installation methods failed!"; \
            echo "PHP version:"; \
            /usr/local/bin/php --version; \
            echo "PHP phar configuration:"; \
            /usr/local/bin/php -i | grep -E "phar\." || true; \
            exit 1; \
        fi; \
        echo "✅ Composer installed successfully via installer script"; \
    fi

# Configure PHP
RUN echo "memory_limit=512M" > /usr/local/etc/php/conf.d/memory.ini && \
    echo "upload_max_filesize=100M" > /usr/local/etc/php/conf.d/uploads.ini && \
    echo "post_max_size=100M" >> /usr/local/etc/php/conf.d/uploads.ini

# Ensure PATH prioritizes Docker image's PHP over any Alpine PHP
ENV PATH="/usr/local/bin:${PATH}"

# Create symlink to ensure 'php' command uses Docker image's PHP
RUN ln -sf /usr/local/bin/php /usr/bin/php || true

# Verify composer is installed and using correct PHP
# Test Composer immediately and reinstall if signature verification fails
RUN echo "=== PHP Binary Locations ===" && \
    which php && \
    /usr/local/bin/php --version && \
    echo "" && \
    echo "=== PATH Check ===" && \
    echo $PATH && \
    echo "" && \
    echo "=== Composer Installation Check ===" && \
    if [ ! -f /usr/local/bin/composer ]; then \
        echo "❌ Composer binary not found at /usr/local/bin/composer"; \
        exit 1; \
    fi && \
    if ! /usr/local/bin/php /usr/local/bin/composer --version > /dev/null 2>&1; then \
        echo "⚠️ Composer PHAR signature verification failed, reinstalling..."; \
        rm -f /usr/local/bin/composer /tmp/composer.phar; \
        curl -sS https://getcomposer.org/download/latest-stable/composer.phar -o /tmp/composer.phar && \
        mv /tmp/composer.phar /usr/local/bin/composer && \
        chmod +x /usr/local/bin/composer && \
        if ! /usr/local/bin/php /usr/local/bin/composer --version > /dev/null 2>&1; then \
            echo "⚠️ Direct PHAR download failed, trying installer script..."; \
            rm -f /usr/local/bin/composer /tmp/composer-setup.php; \
            EXPECTED_SIG=$(curl -sS https://composer.github.io/installer.sig) && \
            curl -sS https://getcomposer.org/installer -o /tmp/composer-setup.php && \
            ACTUAL_SIG=$(/usr/local/bin/php -r "echo hash_file('sha384', '/tmp/composer-setup.php');") && \
            if [ "$EXPECTED_SIG" = "$ACTUAL_SIG" ]; then \
                /usr/local/bin/php /tmp/composer-setup.php --install-dir=/usr/local/bin --filename=composer --quiet && \
                rm -f /tmp/composer-setup.php && \
                chmod +x /usr/local/bin/composer; \
            fi; \
        fi && \
        /usr/local/bin/php /usr/local/bin/composer --version || { \
            echo "❌ Composer reinstall failed after all attempts!"; \
            echo "PHP version:"; \
            /usr/local/bin/php --version; \
            echo "PHP phar configuration:"; \
            /usr/local/bin/php -i | grep -E "phar\." || true; \
            exit 1; \
        }; \
        echo "✅ Composer reinstalled successfully"; \
    fi && \
    echo "" && \
    echo "=== Verifying Composer works ===" && \
    /usr/local/bin/php /usr/local/bin/composer --version && \
    echo "" && \
    echo "=== Composer PHP Check ===" && \
    /usr/local/bin/php /usr/local/bin/composer diagnose 2>&1 | head -20 || echo "⚠️ Composer diagnose had warnings (continuing...)" && \
    echo "" && \
    echo "=== Verifying Composer uses correct PHP ===" && \
    head -1 /usr/local/bin/composer && \
    /usr/local/bin/php -r "echo 'PHP ini path: ' . php_ini_loaded_file() . PHP_EOL;" && \
    echo "" && \
    echo "=== Verifying PHP extensions ===" && \
    /usr/local/bin/php -r "echo 'PHP extensions: '; print_r(get_loaded_extensions());" | grep -E "(simplexml|intl|session|pcntl|fileinfo|dom|xml)" || { \
        echo "❌ Missing required PHP extensions!"; \
        /usr/local/bin/php -m; \
        exit 1; \
    } && \
    echo "✅ Composer verification successful"

# Set working directory
WORKDIR /var/www/html

# Copy composer files
COPY composer.json composer.lock ./

# Final verification of extensions right before composer install
# This ensures Composer will see all required extensions
RUN echo "=== Final PHP Extension Check Before Composer ===" && \
    /usr/local/bin/php -r "echo 'PHP Version: ' . PHP_VERSION . PHP_EOL;" && \
    /usr/local/bin/php -r "echo 'PHP Binary: ' . PHP_BINARY . PHP_EOL;" && \
    /usr/local/bin/php --ini | head -5 && \
    /usr/local/bin/php -m | grep -E "(simplexml|intl|session|pcntl|fileinfo|dom|xml|redis)" && \
    /usr/local/bin/php -r "foreach(['session', 'fileinfo', 'simplexml', 'intl', 'pcntl', 'dom', 'xml', 'redis'] as \$ext) { if (!extension_loaded(\$ext)) { echo 'MISSING: ' . \$ext . PHP_EOL; exit(1); } } echo '✅ All extensions verified' . PHP_EOL;" && \
    echo "=== Composer Platform Check ===" && \
    /usr/local/bin/php /usr/local/bin/composer diagnose | grep -E "(PHP|extensions)" || true

# Install PHP dependencies
# Use explicit PHP path to ensure Composer uses Docker image's PHP
RUN /usr/local/bin/php /usr/local/bin/composer install --no-dev --optimize-autoloader --no-interaction --no-scripts

# Copy application files
COPY . .

# Copy built frontend assets from builder stage
COPY --from=frontend-builder /app/public/build ./public/build

# Run composer scripts (post-install)
# Use --no-scripts to avoid package discovery issues with dev dependencies during build
# Note: Even with --no-scripts, Laravel's ComposerScripts::postAutoloadDump may still trigger package:discover
# If it fails due to Scribe config (dev dependency), we continue since autoload files are already generated
RUN APP_ENV=production /usr/local/bin/php /usr/local/bin/composer dump-autoload --optimize --no-scripts --no-interaction || { \
        echo "⚠️ dump-autoload failed, likely due to Scribe config (dev dependency)"; \
        echo "Checking if autoload files exist..."; \
        if [ -f vendor/autoload.php ] && [ -f vendor/composer/autoload_real.php ]; then \
            echo "✅ Autoload files exist, continuing despite error"; \
        else \
            echo "❌ Autoload files missing, this is a real error"; \
            exit 1; \
        fi; \
    }

# Copy nginx configuration
COPY docker/nginx/default.conf /etc/nginx/http.d/default.conf

# Copy supervisor configuration
COPY docker/supervisor/supervisord.conf /etc/supervisor/conf.d/supervisord.conf

# Set permissions
RUN chown -R www-data:www-data /var/www/html && \
    chmod -R 755 /var/www/html/storage && \
    chmod -R 755 /var/www/html/bootstrap/cache && \
    mkdir -p /var/log/supervisor && \
    chown -R www-data:www-data /var/log/supervisor

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=40s --retries=3 \
  CMD curl -f http://localhost:8000/healthcheck || exit 1

# Expose port
EXPOSE 8000

# Start services via supervisor
CMD ["/usr/bin/supervisord", "-c", "/etc/supervisor/conf.d/supervisord.conf"]

